name: Automation Recon (Pro Hunter Edition)

on:
  schedule:
    - cron: '*/10 * * * *' 
  workflow_dispatch:

jobs:
  recon-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # --- [STATE MANAGEMENT: BIAR TARGET GAK ITU-ITU AJA] ---
      - name: Restore Scan State
        uses: actions/cache@v3
        with:
          path: .last_scan
          key: scan-state-${{ github.run_id }}
          restore-keys: |
            scan-state-

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '>=1.20'

      - name: Install Tools
        run: |
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Python Dependencies
        run: pip install requests

      - name: Run Predator Recon
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          H1_USERNAME: ${{ secrets.H1_USERNAME }}
          H1_API_KEY: ${{ secrets.H1_API_KEY }}
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CRIT: ${{ secrets.TELEGRAM_CRITICAL_ID }}
          TG_GEN: ${{ secrets.TELEGRAM_GENERAL_ID }}
          TG_DATA: ${{ secrets.TELEGRAM_DATA_ID }}
        run: |
          # 1. PILIH TARGET YANG BELUM DI-SCAN (SMART SELECT)
          touch .last_scan
          # Pilih file yang namanya tidak ada di .last_scan
          target_file=$(ls targets/*.txt | shuf | while read f; do grep -q "$(basename $f)" .last_scan || { echo "$f"; break; }; done)
          
          # Jika semua sudah di-scan, reset state
          if [ -z "$target_file" ]; then echo "" > .last_scan; target_file=$(ls targets/*.txt | shuf | head -n 1); fi
          
          program_name=$(basename "$target_file" .txt)
          echo "$program_name" >> .last_scan # Simpan state
          
          echo "=================================================="
          echo "ðŸŽ¯ TARGETING: $program_name"
          echo "=================================================="
          mkdir -p "data/$program_name"

          # 2. SUBFINDER (Max 20m)
          echo "[+] Step 1: Subfinder Starting..."
          timeout 20m subfinder -dL "$target_file" -all -silent -o "data/$program_name/subdomains.txt" > /dev/null 2>&1 || true
          
          if [ -s "data/$program_name/subdomains.txt" ]; then
            # 3. HTTPX (PRO MODE: TECH DETECT & 403 CHECK)
            echo "[+] Step 2: HTTPX Live Check (Tech Detect ON)..."
            timeout 30m httpx -l "data/$program_name/subdomains.txt" -silent -ip -td -mc 200,301,302,403 -o "data/$program_name/active_hosts.txt" > /dev/null 2>&1 || true
            
            if [ -s "data/$program_name/active_hosts.txt" ]; then
                # 4. NUCLEI (PRO MODE: NEW TEMPLATES & SPEED CONTROL)
                echo "[+] Step 3: Nuclei Deep Scan (New Templates & P-Level focus)..."
                # -nt: New Templates, -rl 80: Stealth Speed, -severity: High focus
                timeout 3h nuclei -l "data/$program_name/active_hosts.txt" \
                  -tags exposure,misconfig,takeover,cve2023,cve2024,cve2025 \
                  -severity critical,high,medium \
                  -nt -rl 80 -c 15 -timeout 3 -retries 1 -stats -si 60 -silent \
                  -jsonl -o "data/$program_name/nuclei_results.json" || true
                
                # 5. AI VALIDATION (Kirim Context Lengkap)
                echo "[+] Step 4: AI Analysis (Context Mode)..."
                PROGRAM_NAME=$program_name python scripts/validate.py
                
                # 6. NOTIFIKASI TELEGRAM
                if [ -f "data/$program_name/high_findings.txt" ]; then
                  (echo -e "ðŸš¨ BUG DISCOVERED\n"; cat "data/$program_name/high_findings.txt") | notify -config notify-config.yaml -id p1_p2_alerts || (MSG=$(cat data/$program_name/high_findings.txt) && curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_CRIT" -d "text=$MSG")
                fi
                if [ -f "data/$program_name/low_findings.txt" ]; then
                  MSG_LOW=$(cat "data/$program_name/low_findings.txt")
                  curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_GEN" -d "text=$MSG_LOW" > /dev/null 2>&1 || true
                fi

                # 7. BACKUP ZIP (TXT MODE)
                if [ -s "data/$program_name/nuclei_results.json" ]; then
                   cat "data/$program_name/nuclei_results.json" | grep -oP '"matched-at":"\K[^"]+' > "data/$program_name/HASIL_SCAN_NUCLEI.txt"
                fi
                zip_name="${program_name}_data.zip"
                zip -j "$zip_name" data/$program_name/subdomains.txt data/$program_name/active_hosts.txt data/$program_name/HASIL_SCAN_NUCLEI.txt > /dev/null 2>&1 || true
                curl -v -F chat_id="$TG_DATA" -F document=@"$zip_name" -F caption="ðŸ“¦ DB: $program_name" "https://api.telegram.org/bot$TG_TOKEN/sendDocument" > /dev/null 2>&1 || true
            fi
          fi
