name: Automated Recon (Fast & Furious)

on:
  schedule:
    - cron: '0 */1 * * *'
  workflow_dispatch:

jobs:
  recon-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '>=1.20'

      - name: Install ProjectDiscovery Tools
        run: |
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install -v github.com/projectdiscovery/notify/cmd/notify@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Python Dependencies
        run: pip install google-generativeai requests

      - name: Run Multi-Program Recon
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          H1_USERNAME: ${{ secrets.H1_USERNAME }}
          H1_API_KEY: ${{ secrets.H1_API_KEY }}
          NOTIFY_CONF: ${{ secrets.NOTIFY_CONFIG }}
        run: |
          # ACAK PERUSAHAAN BIAR GAK AIRBNB TERUS
          for target_file in $(ls targets/*.txt | shuf); do
            program_name=$(basename "$target_file" .txt)
            echo "-----------------------------------------------"
            echo "ðŸ”¥ HUNTING STARTED: $program_name"
            echo "-----------------------------------------------"
            
            mkdir -p "data/$program_name"
            
            # 1. SUBFINDER
            subfinder -dL "$target_file" -all -o "data/$program_name/subdomains.txt"
            
            # 2. HTTPX (Cepat)
            cat "data/$program_name/subdomains.txt" | httpx -silent -ip -o "data/$program_name/active_hosts.txt"
            
            # 3. NUCLEI (Bawa 6500+ Template, Gak Pake Rem, Anti-Stuck)
            # -c 50: Buka 50 jalur paralel biar ngebut
            # -timeout 5: Kalau server ngelag 5 detik, langsung buang/skip!
            # -stats -si 60: Munculin progress tiap 1 menit di log
            nuclei -l "data/$program_name/active_hosts.txt" -tags exposure,misconfig,takeover,cve,tech -c 50 -timeout 5 -retries 1 -stats -si 60 -jsonl -o "data/$program_name/nuclei_results.json"
            
            # 4. VALIDASI AI
            PROGRAM_NAME=$program_name python scripts/validate.py
            
            # 5. NOTIFIKASI TELEGRAM
            echo "$NOTIFY_CONF" > notify-config.yaml
            
            # CEK APAKAH ADA DRAF BUG YANG DITEMUKAN
            if; then
              (echo -e "ðŸŽ¯ TARGET: ${program_name^^}\n"; cat "data/$program_name/high_findings.txt") | notify -config notify-config.yaml -id critical_alerts
            fi
            
            # Bersihkan config
            rm -f notify-config.yaml
          done
