name: Automation Recon (Every 20 Mins)

on:
  schedule:
    - cron: '*/20 * * * *' # JALAN SETIAP 20 MENIT (72x Sehari!)
  workflow_dispatch:

jobs:
  recon-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '>=1.20'

      - name: Install ProjectDiscovery Tools
        run: |
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install -v github.com/projectdiscovery/notify/cmd/notify@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Python Dependencies
        run: pip install google-generativeai requests

      - name: Run Sniper Recon (One Shot)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          H1_USERNAME: ${{ secrets.H1_USERNAME }}
          H1_API_KEY: ${{ secrets.H1_API_KEY }}
          NOTIFY_CONF: ${{ secrets.NOTIFY_CONFIG }}
        run: |
          # 1. PILIH SATU TARGET ACAK
          # shuf = ngacak, head -n 1 = ambil satu aja
          target_file=$(ls targets/*.txt | shuf | head -n 1)
          program_name=$(basename "$target_file" .txt)
          
          echo "=================================================="
          echo "üéØ SNIPER TARGET: $program_name"
          echo "‚è∞ Time: $(date)"
          echo "=================================================="
          
          mkdir -p "data/$program_name"
          
          # 2. SUBFINDER (Mode: Sikat Habis tapi Silent)
          # -silent: Biar terminal gak penuh sampah
          # timeout 30m: Kalau 30 menit gak kelar, paksa berhenti biar lanjut
          echo "[+] üîç Running Subfinder (Max 30m)..."
          timeout 30m subfinder -dL "$target_file" -all -silent -o "data/$program_name/subdomains.txt" || echo "‚ö†Ô∏è Subfinder stopped by timeout"
          
          # Cek hasil: Kalau 0, langsung STOP mesin (Hemat waktu)
          count_sub=$(wc -l < "data/$program_name/subdomains.txt")
          echo "‚úÖ Subfinder Done. Found: $count_sub subdomains."
          
          if [ "$count_sub" -gt 0 ]; then
          
            # 3. HTTPX (Mode: Cek Nyawa)
            echo "[+] üåê Running HTTPX (Filtering Alive Hosts)..."
            # -silent: Terminal bersih
            timeout 45m httpx -l "data/$program_name/subdomains.txt" -silent -ip -o "data/$program_name/active_hosts.txt" || echo "‚ö†Ô∏è HTTPX stopped by timeout"
            
            count_live=$(wc -l < "data/$program_name/active_hosts.txt")
            echo "‚úÖ HTTPX Done. Live Targets: $count_live"
            
            if [ "$count_live" -gt 0 ]; then
            
                # 4. NUCLEI (Mode: Los Dol + Info Progress)
                echo "[+] ‚ò¢Ô∏è Running Nuclei (Deep Scan)..."
                # -stats -si 60: INI PENTING! Dia bakal ngomong tiap 1 menit: "Masih jalan bos, progress 10%"
                # Biar kamu tau dia gak stuck.
                nuclei -l "data/$program_name/active_hosts.txt" \
                  -tags exposure,misconfig,takeover,cve,tech \
                  -c 50 -timeout 5 -retries 1 \
                  -stats -si 60 \
                  -silent \
                  -jsonl -o "data/$program_name/nuclei_results.json"
                
                # 5. AI VALIDATION
                echo "[+] üß† Asking Gemini AI..."
                PROGRAM_NAME=$program_name python scripts/validate.py
                
                # 6. NOTIFIKASI
                echo "$NOTIFY_CONF" > notify-config.yaml
                if [ -f "data/$program_name/high_findings.txt" ]; then
                  (echo -e "üéØ TARGET: ${program_name^^}\n"; cat "data/$program_name/high_findings.txt") | notify -config notify-config.yaml -id critical_alerts
                else
                  echo "üí§ Scan selesai. Tidak ada bug valid untuk dilapor."
                fi
                rm -f notify-config.yaml
            
            else
                echo "‚ùå HTTPX selesai tapi 0 website yang hidup. Target ini mati suri."
            fi
          else
            echo "‚ùå Subfinder selesai tapi 0 subdomain. Target ini kosong."
          fi
          
          echo "=================================================="
          echo "üèÅ MISSION COMPLETE: $program_name"
          echo "=================================================="
